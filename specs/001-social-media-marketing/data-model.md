# Data Model: Social Media Marketing Dashboard

**Feature**: 001-social-media-marketing  
**Date**: 2025-09-30

## Entity Relationship Diagram

```
┌─────────────┐
│   Brief     │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────┴────────┐         ┌──────────────┐
│    Idea       │         │    Asset     │
└──────┬────────┘         └──────────────┘
       │ 1                      
       │                        
       │ N                      
┌──────┴────────┐
│   Creative    │
└──────┬────────┘
       │ 1
       │
       │ 1
┌──────┴────────┐
│   Approval    │
└───────────────┘
```

## Entities

### Brief
**Description**: Contains product information, campaign message, target regions/demographics. Source can be typed text or uploaded document.

**Fields**:
- id: UUID, primary key
- content: TEXT, full brief content (extracted from file or direct input)
- campaign_message: TEXT, message to include in final creatives
- regions: JSON array, list of target regions (e.g., ["US", "EU", "APAC"])
- demographics: JSON array, list of target demographics (e.g., ["18-25", "25-35"])
- source_type: ENUM('text', 'txt', 'pdf', 'docx'), how brief was provided
- source_filename: VARCHAR(255), original filename if uploaded, nullable
- source_path: VARCHAR(512), filesystem path if uploaded, nullable
- created_at: TIMESTAMP, creation timestamp
- updated_at: TIMESTAMP, last update timestamp

**Validation Rules**:
- content must not be empty
- regions must contain at least one region
- demographics must contain at least one demographic
- campaign_message must not be empty
- source_type must be valid enum value

**State Transitions**: None (immutable once created, except delete)

### Asset
**Description**: Brand or product images uploaded by user. Brand assets include logos and style elements, product assets show the products being marketed.

**Fields**:
- id: UUID, primary key
- asset_type: ENUM('brand', 'product'), type of asset
- filename: VARCHAR(255), original filename
- file_path: VARCHAR(512), filesystem storage path
- mime_type: VARCHAR(100), MIME type (should be image/jpeg)
- file_size: INTEGER, size in bytes
- brand_colors: JSON array, extracted color palette from brand assets, nullable
- created_at: TIMESTAMP, upload timestamp

**Validation Rules**:
- asset_type must be 'brand' or 'product'
- mime_type must be 'image/jpeg'
- file_size must be <= 10MB (10485760 bytes)
- file_path must be unique
- brand_colors only populated for brand assets

**State Transitions**: None (immutable once uploaded, except delete)

### Idea
**Description**: LLM-generated creative concept for specific region/demographic combination. One idea per region/demographic pair from the brief.

**Fields**:
- id: UUID, primary key
- brief_id: UUID, foreign key to Brief
- region: VARCHAR(50), target region for this idea
- demographic: VARCHAR(50), target demographic for this idea
- content: TEXT, LLM-generated idea content
- language_code: VARCHAR(10), language for this region (e.g., 'en-US', 'es-ES')
- generation_count: INTEGER, how many times regenerated (starts at 1)
- created_at: TIMESTAMP, first generation timestamp
- updated_at: TIMESTAMP, last regeneration timestamp

**Validation Rules**:
- brief_id must reference existing Brief
- region must match one from brief.regions
- demographic must match one from brief.demographics
- content must not be empty
- generation_count must be >= 1

**State Transitions**:
- Created -> Regenerated (content updated, generation_count incremented)

**Relationships**:
- Belongs to one Brief
- Has many Creatives

### Creative
**Description**: Final social media image asset generated by Adobe Firefly, includes campaign message and branding elements.

**Fields**:
- id: UUID, primary key
- idea_id: UUID, foreign key to Idea
- file_path: VARCHAR(512), filesystem path to generated image
- mime_type: VARCHAR(100), MIME type (image/jpeg or image/png)
- file_size: INTEGER, size in bytes
- firefly_job_id: VARCHAR(255), Adobe Firefly job ID for tracking
- generation_count: INTEGER, regeneration count (starts at 1)
- created_at: TIMESTAMP, first generation timestamp
- updated_at: TIMESTAMP, last regeneration timestamp

**Validation Rules**:
- idea_id must reference existing Idea
- file_path must be unique
- generation_count must be >= 1

**State Transitions**:
- Created -> Regenerated (new file, generation_count incremented)

**Relationships**:
- Belongs to one Idea
- Has one Approval

### Approval
**Description**: Tracks creative and regional approval status for each creative. Deploy only enabled when both approvals granted.

**Fields**:
- id: UUID, primary key
- creative_id: UUID, foreign key to Creative, unique
- creative_approved: BOOLEAN, creative approval status
- creative_approved_at: TIMESTAMP, when creative was approved, nullable
- regional_approved: BOOLEAN, regional approval status
- regional_approved_at: TIMESTAMP, when regional was approved, nullable
- deployed: BOOLEAN, deployment status
- deployed_at: TIMESTAMP, when deployed, nullable
- created_at: TIMESTAMP, record creation timestamp
- updated_at: TIMESTAMP, last update timestamp

**Validation Rules**:
- creative_id must reference existing Creative
- creative_id must be unique (one approval per creative)
- deployed cannot be true unless both creative_approved and regional_approved are true
- deployed_at must be null if deployed is false

**State Transitions**:
- Created (both approvals false) -> Creative Approved -> Both Approved -> Deployed
- Created (both approvals false) -> Regional Approved -> Both Approved -> Deployed
- Order of creative/regional approval doesn't matter
- Cannot transition to Deployed without both approvals

**Relationships**:
- Belongs to one Creative (one-to-one)

## Database Schema (PostgreSQL)

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Briefs table
CREATE TABLE briefs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    content TEXT NOT NULL,
    campaign_message TEXT NOT NULL,
    regions JSONB NOT NULL,
    demographics JSONB NOT NULL,
    source_type VARCHAR(10) NOT NULL CHECK (source_type IN ('text', 'txt', 'pdf', 'docx')),
    source_filename VARCHAR(255),
    source_path VARCHAR(512),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_briefs_created_at ON briefs(created_at DESC);

-- Assets table
CREATE TABLE assets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    asset_type VARCHAR(10) NOT NULL CHECK (asset_type IN ('brand', 'product')),
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(512) NOT NULL UNIQUE,
    mime_type VARCHAR(100) NOT NULL,
    file_size INTEGER NOT NULL CHECK (file_size <= 10485760),
    brand_colors JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_assets_type ON assets(asset_type);
CREATE INDEX idx_assets_created_at ON assets(created_at DESC);

-- Ideas table
CREATE TABLE ideas (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    brief_id UUID NOT NULL REFERENCES briefs(id) ON DELETE CASCADE,
    region VARCHAR(50) NOT NULL,
    demographic VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    language_code VARCHAR(10) NOT NULL,
    generation_count INTEGER NOT NULL DEFAULT 1 CHECK (generation_count >= 1),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ideas_brief ON ideas(brief_id);
CREATE INDEX idx_ideas_created_at ON ideas(created_at DESC);

-- Creatives table
CREATE TABLE creatives (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    idea_id UUID NOT NULL REFERENCES ideas(id) ON DELETE CASCADE,
    file_path VARCHAR(512) NOT NULL UNIQUE,
    mime_type VARCHAR(100) NOT NULL,
    file_size INTEGER NOT NULL,
    firefly_job_id VARCHAR(255),
    generation_count INTEGER NOT NULL DEFAULT 1 CHECK (generation_count >= 1),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_creatives_idea ON creatives(idea_id);
CREATE INDEX idx_creatives_created_at ON creatives(created_at DESC);

-- Approvals table
CREATE TABLE approvals (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    creative_id UUID NOT NULL UNIQUE REFERENCES creatives(id) ON DELETE CASCADE,
    creative_approved BOOLEAN NOT NULL DEFAULT FALSE,
    creative_approved_at TIMESTAMP WITH TIME ZONE,
    regional_approved BOOLEAN NOT NULL DEFAULT FALSE,
    regional_approved_at TIMESTAMP WITH TIME ZONE,
    deployed BOOLEAN NOT NULL DEFAULT FALSE,
    deployed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_deployed_requires_approvals CHECK (
        deployed = FALSE OR (creative_approved = TRUE AND regional_approved = TRUE)
    )
);

CREATE INDEX idx_approvals_creative ON approvals(creative_id);
CREATE INDEX idx_approvals_status ON approvals(creative_approved, regional_approved, deployed);
```

## Indexes Strategy

**Performance Considerations**:
- Foreign key columns indexed for join performance
- Created_at columns indexed for chronological queries
- Approval status composite index for queue filtering
- File_path unique indexes prevent duplicate storage

## Migration Strategy

**Alembic Migrations**:
1. Initial migration creates all tables with constraints
2. Future migrations for schema changes
3. Downgrade path provided for all migrations

**Data Integrity**:
- Foreign keys with CASCADE delete ensure orphan prevention
- Check constraints enforce business rules at database level
- Unique constraints prevent duplicates
- NOT NULL constraints prevent invalid states
